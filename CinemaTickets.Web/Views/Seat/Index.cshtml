@model CinemaTickets.Web.ViewModels.SeatViewModel
@{
    ViewBag.Title = "Index";
}

<h2>Seat selection</h2>
<hr />
<div id="screen"><b>Screen</b></div>
<div id="seatsTable"></div>
<button id="finishPurchase" class="btn btn-primary btn-lg" style="float:right;margin-top:-10px;">Finish purchase</button>

<div>Total price - @Model.TotalPrice</div>
<span id="ticketsLeft"></span>

@section Scripts{
    <script>
        @{
            var html = "<table class=\"table table-bordered\"><tr>";
            var counter = 1;
        }
        @foreach (var item in Model.SeatDtos)
        {
            var color = "green";
            if (item.IsTaken)
            {
                color = "red";
            }

            if(counter == 11)
            {
                html += @"</tr><tr>";
                counter = 1;
            }
            html += $"<td seatID=\"{item.SeatID}\" style=\"text-align:center;background-color:{color};cursor:pointer;\"" + $">{item.Column}</td>";
            counter++;
        }
        @{
            html += @"</tr></table>";
            var htmlToPass = Html.Raw(html);
        }
        var tableAsString = `@htmlToPass`;
        $('#seatsTable').append($(tableAsString));

        var seats = [];
        var maxSeatCount = @Model.Adults + @Model.KidsRetirees + @Model.Students;
        $('table td').click(function () {
            var colorOfSeat = this.style.backgroundColor;
            var tdSeatID = $(this).attr('seatID');
            if (colorOfSeat === 'red') {
                return;
            }

            if(maxSeatCount === 0){
                seats = [];
                $('table tr').each(function() {
                    $.each(this.cells, function(){
                        if(this.style.backgroundColor == 'yellow'){
                            this.style.backgroundColor = 'green';
                        }
                    });
                });
                maxSeatCount = @Model.Adults + @Model.KidsRetirees + @Model.Students;
                $('#ticketsLeft').empty();
                $('#ticketsLeft').append(maxSeatCount + " tickets left to choose.");
                return;
            }

            var index = seats.indexOf(tdSeatID);
            if (index > -1) {
                this.style.backgroundColor = 'green';
                seats.splice(index, 1);
                maxSeatCount++;
            }
            else {
                this.style.backgroundColor = 'yellow';
                seats.push(tdSeatID);
                maxSeatCount--;
            }
            $('#ticketsLeft').empty();
            $('#ticketsLeft').append(maxSeatCount + " tickets left to choose.");
        })

        $('#finishPurchase').click(function (e) {
            e.preventDefault();
            if(maxSeatCount != 0){
                alert("You still have " + maxSeatCount + " tickets to select.");
                return;
            }
            var stringSeats = seats.join(',');

            var fd = new FormData();
            fd.append("seats", stringSeats);
            fd.append("kidsRetirees",@Model.KidsRetirees);
            fd.append("students",@Model.Students);
            fd.append("adults",@Model.Adults);
            fd.append("projectionID",@Model.ProjectionID);

            $.ajax({
                url: "@Url.Action("BuyTickets", "Seat")",
                type: 'POST',
                processData: false,
                contentType: false,
                data: fd,
                success: successCallback,
                error: errorCallback
            })
        });

        function successCallback(){
            alert("success");
            window.location.href = "/Ticket/VisualizeTickets";
        }
        function errorCallback(){
            alert("error")
        }
    </script>
}